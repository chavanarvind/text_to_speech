import azure.cognitiveservices.speech as speechsdk
from moviepy.editor import VideoFileClip

# 🔹 Your Azure Credentials
AZURE_SPEECH_KEY = ""
AZURE_REGION = "eastus"  # Example: "eastus"

# 🔹 Step 1: Extract audio from video
def extract_audio_from_video(video_path, output_wav="output.wav"):
    print("🔧 Extracting audio from video...")
    clip = VideoFileClip(video_path)
    clip.audio.write_audiofile(output_wav, codec='pcm_s16le')  # WAV with PCM codec
    print("✅ Audio saved as:", output_wav)
    return output_wav

# 🔹 Step 2: Translate extracted audio using Azure
def translate_audio_azure(audio_path, target_language="hi"):
    print(f"🌐 Translating to '{target_language}' using Azure Speech Translation...")

    translation_config = speechsdk.translation.SpeechTranslationConfig(
        subscription=AZURE_SPEECH_KEY,
        region=AZURE_REGION
    )
    translation_config.speech_recognition_language = "en-US"  # source
    translation_config.add_target_language(target_language)

    audio_config = speechsdk.AudioConfig(filename=audio_path)

    recognizer = speechsdk.translation.TranslationRecognizer(
        translation_config=translation_config,
        audio_config=audio_config
    )

    result = recognizer.recognize_once()

    if result.reason == speechsdk.ResultReason.TranslatedSpeech:
        print("\n✅ Translation successful!")
        print("🔹 Original (en):", result.text)
        print(f"🔹 Translated ({target_language}):", result.translations[target_language])
        return result.text, result.translations[target_language]
    else:
        print("❌ Translation failed.")
        print("Reason:", result.reason)
        return None, None

# 🔹 Step 3: Run the whole pipeline
if __name__ == "__main__":
    video_file = "./video_analysis/video_Overview_OCC.mp4"  # 🔁 Replace with your actual file
    wav_file = extract_audio_from_video(video_file)
    translate_audio_azure(wav_file, target_language="hi")
