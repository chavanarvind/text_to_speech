import gradio as gr
import subprocess
import os
import azure.cognitiveservices.speech as speechsdk

# üõ† Replace with the path to your ffmpeg.exe
ffmpeg_path = r"C:\Path\To\ffmpeg\bin\ffmpeg.exe"

# üõ† Replace with your Azure Speech credentials
AZURE_SPEECH_KEY = "YOUR_AZURE_SPEECH_KEY"
AZURE_REGION = "YOUR_AZURE_REGION"  # e.g., "eastus", "centralindia"

def extract_audio(input_video_path, output_audio_path="temp_audio.wav"):
    command = [
        ffmpeg_path,
        "-y",
        "-i", input_video_path,
        "-vn",
        "-acodec", "pcm_s16le",
        "-ar", "44100",
        "-ac", "2",
        output_audio_path
    ]
    subprocess.run(command, check=True)
    return output_audio_path

def translate_audio_with_azure(audio_path, from_lang, to_lang):
    translation_config = speechsdk.translation.SpeechTranslationConfig(
        subscription=AZURE_SPEECH_KEY,
        region=AZURE_REGION,
        speech_recognition_language=from_lang
    )
    translation_config.add_target_language(to_lang)

    audio_config = speechsdk.audio.AudioConfig(filename=audio_path)
    recognizer = speechsdk.translation.TranslationRecognizer(
        translation_config=translation_config,
        audio_config=audio_config
    )

    result = recognizer.recognize_once()

    if result.reason == speechsdk.ResultReason.TranslatedSpeech:
        return result.translations[to_lang]
    elif result.reason == speechsdk.ResultReason.RecognizedSpeech:
        return "Speech recognized but not translated."
    else:
        return f"‚ùå Error: {result.reason}"

def handle_video(video, from_lang, to_lang):
    audio_path = extract_audio(video)
    translated_text = translate_audio_with_azure(audio_path, from_lang, to_lang)
    if os.path.exists(audio_path):
        os.remove(audio_path)
    return translated_text

# Gradio interface
iface = gr.Interface(
    fn=handle_video,
    inputs=[
        gr.Video(label="Upload Video"),

        gr.Dropdown(
            choices=[
                ("English (US)", "en-US"),
                ("Hindi", "hi-IN"),
                ("French", "fr-FR"),
                ("Spanish", "es-ES"),
                ("German", "de-DE")
            ],
            label="Source Language",
            value="en-US"
        ),

        gr.Dropdown(
            choices=[
                ("Hindi", "hi"),
                ("English", "en"),
                ("French", "fr"),
                ("Spanish", "es"),
                ("German", "de"),
                ("Arabic", "ar")
            ],
            label="Target Language",
            value="hi"
        ),
    ],
    outputs="text",
    title="üéô AI Video Translator",
    description="Upload a video to extract, transcribe, and translate speech using Azure Speech Services."
)

iface.launch()
