import pandas as pd
import os

# === Ensure folders exist ===
os.makedirs('./data', exist_ok=True)
os.makedirs('./data/cleaned_parts', exist_ok=True)

# === FILE PATHS ===
csv_path = './data/combined.csv'
parquet_path = './data/combined.parquet'
target_map_path = './data/cleaned_parts/target_map.csv'

# === STEP 1: Convert CSV to Parquet if not exists ===
if not os.path.exists(parquet_path):
    print("🔁 Converting CSV to Parquet...")
    first = True
    for chunk in pd.read_csv(csv_path, chunksize=1_000_000, dtype=str):
        chunk = chunk.drop_duplicates()
        chunk.to_parquet(parquet_path, index=False, engine='pyarrow', append=not first)
        first = False
    print("✅ CSV converted to Parquet:", parquet_path)
else:
    print("✅ Parquet file already exists:", parquet_path)

# === STEP 2: Load target map ===
print("📥 Loading target map...")
target_map = pd.read_csv(target_map_path, usecols=['CMPNT_CAT_CD_DESC', 'Final Category'], dtype=str)
target_map = target_map.drop_duplicates()
target_map['CMPNT_CAT_CD_DESC'] = target_map['CMPNT_CAT_CD_DESC'].astype('category')

# === STEP 3: Merge in chunks and OVERWRITE combined.parquet ===
print("🔁 Merging with target_map and updating the same file...")
parquet_reader = pd.read_parquet(parquet_path, engine='pyarrow', chunksize=1_000_000)
first = True

for chunk in parquet_reader:
    chunk = chunk.drop_duplicates()
    chunk['CMPNT_CAT_CD_DESC'] = chunk['CMPNT_CAT_CD_DESC'].astype('category')
    merged = chunk.merge(target_map, how='left', on='CMPNT_CAT_CD_DESC')
    merged.to_parquet(parquet_path, index=False, engine='pyarrow', append=not first)
    first = False

print("✅ Done. File updated:", parquet_path)
