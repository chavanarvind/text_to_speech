import os
import argparse
from azureml.core import Run, Dataset

def main(output_path):
    # Get run context and workspace
    run = Run.get_context()
    ws = run.experiment.workspace

    # Get dataset by name
    dataset = Dataset.get_by_name(ws, name='harmonized_bom_data_asset')

    # Get list of file paths in the dataset
    file_paths = dataset.to_path()

    # Filter for Parquet files and take only the first 2
    parquet_files = [path for path in file_paths if path[0].endswith(".parquet")][:2]

    if not parquet_files:
        print("No parquet files found.")
        return

    print("Files selected for download:")
    for path in parquet_files:
        print(f" - {path[0]}")

    # Create a dataset from the 2 selected parquet files
    limited_dataset = Dataset.File.from_files([(dataset.datastore, path[0]) for path in parquet_files])

    # Download to output path
    os.makedirs(output_path, exist_ok=True)
    limited_dataset.download(target_path=output_path, overwrite=True)

    print(f"\nSelected Parquet files downloaded to: {output_path}")


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--output_path", type=str, required=True)
    args = parser.parse_args()

    main(args.output_path)
