# === FIX 3: Safe evaluation of needs_model
try:
    mapped_df['Final Category Filled'] = mapped_df['Final Category'].notna() & mapped_df['Final Category'].astype(str).str.strip().ne("")
    mapped_df['Final Subcategory Filled'] = mapped_df['Final Subcategory'].notna() & mapped_df['Final Subcategory'].astype(str).str.strip().ne("")
    mapped_df['needs_model'] = ~mapped_df['Final Category Filled'] | ~mapped_df['Final Subcategory Filled']
except Exception as e:
    print(f"[ERROR] Failed to evaluate fill flags: {e}. Marking all mapped rows as needs_model.")
    mapped_df['needs_model'] = True
    mapped_df['Final Category Filled'] = False
    mapped_df['Final Subcategory Filled'] = False
