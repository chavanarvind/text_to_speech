# Apply category and subcategory priority before deduplication
df['category_priority'] = df['prediction_flag'].map({
    'Mapped_PreExtracted': 2,
    'Mapped': 2,
    'High Confidence': 1,
    'Low Confidence': 0
}).fillna(0)

df['subcategory_priority'] = df['prediction_flag_subcategory'].map({
    'Mapped': 2,
    'High Confidence': 1,
    'Low Confidence': 0,
    'Fallback': -1
}).fillna(0)

# Sort and deduplicate
df = df.sort_values(
    by=['CMPNT_MATL_NUM', 'category_priority', 'subcategory_priority'],
    ascending=[True, False, False]
)
df = df.drop_duplicates(subset="CMPNT_MATL_NUM", keep="first")
