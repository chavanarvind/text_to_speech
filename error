import os
import shutil
from azureml.core import Workspace, Model

# === CONFIG ===
# Paths to your trained artifacts
model_file = './data/validation_step/model_artifects/final_model.joblib'
ordinal_file = './data/validation_step/model_artifects/ordinal_encoder.pkl'
scaler_file = './data/validation_step/model_artifects/scaler.pkl'

# Target folder to combine artifacts
combined_folder = './model_artifacts_to_register'
os.makedirs(combined_folder, exist_ok=True)

# Copy files to combined folder
shutil.copy2(model_file, os.path.join(combined_folder, 'final_model.joblib'))
shutil.copy2(ordinal_file, os.path.join(combined_folder, 'ordinal_encoder.pkl'))
shutil.copy2(scaler_file, os.path.join(combined_folder, 'scaler.pkl'))

print(f"✅ All files copied to: {combined_folder}")

# === REGISTER IN AZURE ML ===
ws = Workspace.from_config(path=".azureml/dev_config.json")  # Adjust if needed

registered_model = Model.register(
    workspace=ws,
    model_path=combined_folder,                  # Folder path
    model_name="lightgbm_combined_model",        # Logical name in Azure
    description="LightGBM + OrdinalEncoder + Scaler",
    tags={"type": "inference_bundle", "project": "your_project"}
)

print(f"✅ Model registered: {registered_model.name} v{registered_model.version}")
