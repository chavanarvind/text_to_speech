    # ✅ Add keys to discarded datasets (merging ERP & TRU like in matching rounds)
    print("\n[PATCH] Merging ERP_DISCARDED and TRU_DISCARDED to create keys")

    # Merge discarded ERP and TRU to simulate matches
    discarded_matches = (erp_discarded[ERP_COLS + ['key_erp']]
                         .merge(tru_discarded[TRU_COLS + ['key_tru']],
                                left_on=[ERP_MAT_NUM],
                                right_on=[TRU_MAT_NUM],
                                how='inner'))

    if not discarded_matches.empty:
        discarded_matches['key_prediction'] = discarded_matches['key_erp'] + '_' + discarded_matches['key_tru']
        print(f"[INFO] Created {len(discarded_matches)} ERP–TRU pairs in discarded data")
    else:
        print("[INFO] No ERP–TRU pairs found in discarded data")

    # Add dummy key_prediction for rows with no match
    erp_discarded = erp_discarded.copy()
    tru_discarded = tru_discarded.copy()

    if 'key_tru' not in erp_discarded.columns:
        erp_discarded['key_tru'] = 'NO_TRU'
    if 'key_erp' not in tru_discarded.columns:
        tru_discarded['key_erp'] = 'NO_ERP'

    erp_discarded['key_prediction'] = erp_discarded['key_erp'] + '_' + erp_discarded['key_tru']
    tru_discarded['key_prediction'] = tru_discarded['key_erp'] + '_' + tru_discarded['key_tru']

    # ✅ Filter out known rejections from discarded data
    fortrea_folder = os.path.dirname(os.path.realpath(__file__))
    fortrea_folder = os.path.abspath(os.path.join(fortrea_folder, os.pardir))
    known_rejections_df = pd.read_csv(f'{fortrea_folder}/reference_tables/rejections_fortrea.csv')
    add_key_prediction(known_rejections_df)
    known_rejections = set(known_rejections_df['key_prediction'].unique())

    erp_discarded = erp_discarded[~erp_discarded['key_prediction'].isin(known_rejections)].copy()
    tru_discarded = tru_discarded[~tru_discarded['key_prediction'].isin(known_rejections)].copy()

    print(f"[INFO] ERP_DISCARDED size after rejection filter: {len(erp_discarded)}")
    print(f"[INFO] TRU_DISCARDED size after rejection filter: {len(tru_discarded)}")

    return erp, tru, erp_discarded, tru_discarded, run_params, tru_no_common, tru_off_specs_no_common, bundles
