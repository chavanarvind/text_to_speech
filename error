import os
import time
import re
import polars as pl

# --- Clean text using your custom rules ---
def clean_text_pipeline(text):
    if not isinstance(text, str):
        return text
    try:
        text = text.lower()
        text = re.sub('[^A-Za-z0-9&% ]+', '', text).strip()
        text = re.sub(r"\s*%\s*", "% ", text)
        text = re.sub(r'(canada|can|(ca\d+)$|ca)', r' \1', text)
        text = re.sub('canada\s*(\d{2,})|(canada\d+)|canada|can\s*(\d{2,})|(can\d+)|can|(ca\d+)|ca\s(\d{2,})|ca$|(ca\s)', '', text).strip()
        text = re.sub(r"(\D)(\d+)(\s*)(ml|l|gr|gm|g|ct)", r"\1 \2\3\4 ", text).strip()
        text = re.sub("(\s)(spf)\s*([\d+])", r"\1\2\3", text).strip()
        text = re.sub('([\d+])\s*(?:ml|l|gr|gm|g|ct)(?: |$)', lambda z: z.group().replace(" ", ""), text).strip()
        text = re.sub(r"(\D)(spf\d+)", r'\1 \2 ', text).strip()
        return text
    except:
        return text

# --- Main function to process and overwrite ---
def process_and_overwrite(file):
    try:
        print(f"🔄 Processing: {os.path.basename(file)}")
        start = time.time()
        df = pl.read_parquet(file)

        # Unique values from both columns
        values = set(df["MATL_SHRT_DESC"].drop_nulls().unique().to_list() + 
                     df["CMPNT_MATL_DESC"].drop_nulls().unique().to_list())

        # Create map of cleaned values
        value_map = {v: clean_text_pipeline(v) for v in values if isinstance(v, str)}

        # Apply cleaned values
        df = df.with_columns([
            pl.col("MATL_SHRT_DESC").map_dict(value_map, return_dtype=pl.Utf8),
            pl.col("CMPNT_MATL_DESC").map_dict(value_map, return_dtype=pl.Utf8)
        ])

        # Combine both cleaned columns
        df = df.with_columns([
            (pl.col("MATL_SHRT_DESC").fill_null('') + pl.lit(" ") + pl.col("CMPNT_MATL_DESC").fill_null(''))
            .str.strip_chars()
            .alias("MATL_SHRT_DESC_AND_CMPNT_MATL_DESC")
        ])

        df.write_parquet(file)  # Overwrite original file

        print(f"✅ Done: {os.path.basename(file)} | ⏱️ {time.time() - start:.2f}s")
    except Exception as e:
        print(f"❌ Failed: {os.path.basename(file)} -> {e}")
