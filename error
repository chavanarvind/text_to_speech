# abbreviation step for one file
import os
import re
import pandas as pd

# --- Paths ---
input_file = './data/sample_cleaned.parquet'   # ⬅️ Update this path if needed
abbrev_csv_path = './data/abbreviation_expension_updated.csv'

# --- Load abbreviation mapping ---
abbrev_df = pd.read_csv(abbrev_csv_path)
abbrev_map = {k.lower(): v for k, v in zip(abbrev_df['Abbreviation_list'], abbrev_df['Abbreviation_Expension'])}

# --- Compile regex for full-word, case-insensitive matching ---
abbrev_pattern = re.compile(
    r'\b(' + '|'.join(re.escape(k) for k in abbrev_map.keys()) + r')\b',
    flags=re.IGNORECASE
)

# --- Function to replace matched abbreviations ---
def replace_match(m):
    return abbrev_map.get(m.group(0).lower(), m.group(0))

# --- Process one file ---
try:
    print(f"⏳ Expanding abbreviations in: {os.path.basename(input_file)}")
    df = pd.read_parquet(input_file)

    df['MATL_SHRT_DESC_AND_CMPNT_MATL_DESC'] = df['MATL_SHRT_DESC_AND_CMPNT_MATL_DESC'].str.replace(
        abbrev_pattern, replace_match, regex=True
    )

    df.to_parquet(input_file, index=False)
    print(f"✅ Done: {input_file}")
except Exception as e:
    print(f"❌ Failed: {os.path.basename(input_file)} -> {e}")
