import sys
import json
from datetime import datetime
from azureml.core import Workspace, Experiment, Environment, Dataset, Datastore
from azureml.core.authentication import ServicePrincipalAuthentication
from azureml.core.runconfig import RunConfiguration
from azureml.pipeline.core import Pipeline, PipelineData
from azureml.pipeline.steps import PythonScriptStep
from azureml.data import OutputFileDatasetConfig

# === ENV: dev or prod ===
ENV = 'dev'  # Change to 'prod' as needed

def get_workspace_from_config(path):
    with open(path) as f:
        cfg = json.load(f)
    return Workspace(subscription_id=cfg["subscription_id"],
                     resource_group=cfg["resource_group"],
                     workspace_name=cfg["workspace_name"])

def get_workspace_from_sp(args, config_file):
    tenant_id = args[1]
    client_id = args[2]
    client_secret = args[3]
    sp_auth = ServicePrincipalAuthentication(
        tenant_id=tenant_id,
        service_principal_id=client_id,
        service_principal_password=client_secret
    )
    with open(config_file) as f:
        cfg = json.load(f)
    return Workspace(subscription_id=cfg["subscription_id"],
                     resource_group=cfg["resource_group"],
                     workspace_name=cfg["workspace_name"],
                     auth=sp_auth)

def get_run_config(ws, compute_name, env_name):
    run_config = RunConfiguration()
    run_config.target = compute_name
    run_config.environment = Environment.get(workspace=ws, name=env_name)
    return run_config

# === Resolve environment-specific values ===
if len(sys.argv) > 3:
    config_file = '../.azureml/dev_config.json' if ENV == 'dev' else '../.azureml/prod_config.json'
    ws = get_workspace_from_sp(sys.argv, config_file)
else:
    config_file = '../.azureml/dev_config.json' if ENV == 'dev' else '../.azureml/prod_config.json'
    ws = get_workspace_from_config(config_file)

compute_target_name = "llm-gpu-cluster-2" if ENV == 'dev' else "bom-cluster-2"
compute_target = ws.compute_targets[compute_target_name]
compute_target_1 = ws.compute_targets["rpmTestLoad"]
datastore_name = "xbomrefadlsg2" if ENV == 'dev' else "xbom_prod_adlsgen2"
env_name = "Bom_X_Evaluator"

# === Set up run config ===
run_config = get_run_config(ws, compute_target_name, env_name)
default_ds = Datastore.get(ws, datastore_name)
