print('-' * 60)
NLP_list_ERP_folder = os.path.dirname(os.path.realpath(__file__))
NLP_list_ERP_folder = os.path.abspath(os.path.join(NLP_list_ERP_folder, os.pardir))
xmatches_NLP_list_ERP = pd.read_csv(f'{NLP_list_ERP_folder}/reference_tables/NLP_list_ERP.csv', encoding='latin1', dtype='str')

print('‚úÖ STEP 1: Loaded NLP_list_ERP.csv')
print(xmatches_NLP_list_ERP.head())
# Debug: Check for target pair in reference table
check_pair = xmatches_NLP_list_ERP[
    (xmatches_NLP_list_ERP[ERP_PART_ID] == "6115990") &
    (xmatches_NLP_list_ERP[TRU_SPEC_ID] == "PC-046458")
]
print(f"üîç Is target pair in reference table? {not check_pair.empty}")

# Merge ERP text
xmatches_NLP_list_ERP_with_text = xmatches_NLP_list_ERP.merge(
    erp_full[['text_for_matching_erp', ERP_PART_ID]].drop_duplicates(),
    how='left',
    on=ERP_PART_ID
)
print('‚úÖ STEP 2: After merging ERP text')
print(xmatches_NLP_list_ERP_with_text.head())
# Debug: Check for target pair
check_pair = xmatches_NLP_list_ERP_with_text[
    (xmatches_NLP_list_ERP_with_text[ERP_PART_ID] == "6115990") &
    (xmatches_NLP_list_ERP_with_text[TRU_SPEC_ID] == "PC-046458")
]
print(f"üîç Is target pair present after ERP merge? {not check_pair.empty}")

# Merge TRU text
xmatches_NLP_list_ERP_with_text = xmatches_NLP_list_ERP_with_text.merge(
    tru_full[['text_for_matching_tru', TRU_SPEC_ID]].drop_duplicates(),
    how='left',
    on=TRU_SPEC_ID
)
print('‚úÖ STEP 3: After merging TRU text')
print(xmatches_NLP_list_ERP_with_text.head())
# Debug: Check for target pair
check_pair = xmatches_NLP_list_ERP_with_text[
    (xmatches_NLP_list_ERP_with_text[ERP_PART_ID] == "6115990") &
    (xmatches_NLP_list_ERP_with_text[TRU_SPEC_ID] == "PC-046458")
]
print(f"üîç Is target pair present after TRU merge? {not check_pair.empty}")

# Select required columns
xmatches_NLP_list_ERP_with_text = xmatches_NLP_list_ERP_with_text[[ERP_PART_ID,
                                                                   TRU_SPEC_ID,
                                                                   'text_for_matching_erp',
                                                                   'text_for_matching_tru']]
print('‚úÖ STEP 4: After selecting relevant columns')
# Debug: Check for target pair
check_pair = xmatches_NLP_list_ERP_with_text[
    (xmatches_NLP_list_ERP_with_text[ERP_PART_ID] == "6115990") &
    (xmatches_NLP_list_ERP_with_text[TRU_SPEC_ID] == "PC-046458")
]
print(f"üîç Is target pair still present after column filtering? {not check_pair.empty}")

# Drop duplicates
xmatches_NLP_list_ERP_with_text = xmatches_NLP_list_ERP_with_text.drop_duplicates()
print('‚úÖ STEP 5: After dropping duplicates')
# Debug: Check for target pair
check_pair = xmatches_NLP_list_ERP_with_text[
    (xmatches_NLP_list_ERP_with_text[ERP_PART_ID] == "6115990") &
    (xmatches_NLP_list_ERP_with_text[TRU_SPEC_ID] == "PC-046458")
]
print(f"üîç Is target pair still present after dropping duplicates? {not check_pair.empty}")
