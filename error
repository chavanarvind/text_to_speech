# üöÄ STEP 1: Force Pair Matching for NLP_LIST_ERP
if "nlp_list_erp" in round_name.lower():
    print("-" * 60)
    print(f"üîÑ FORCE PAIR LOGIC FOR ALL REFERENCE PAIRS in {round_name}")

    # Load all forced pairs
    forced_pairs = reference_table[[ERP_PART_ID, TRU_SPEC_ID]].drop_duplicates()
    print(f"‚úÖ Total forced pairs in reference table: {len(forced_pairs)}")

    # Filter ERP records for forced pairs
    erp_forced = erp_full[ERP_MATCH_COLS].merge(
        forced_pairs, on=ERP_PART_ID, how='inner'
    )
    print(f"‚úÖ ERP records found for forced pairs: {len(erp_forced)}")

    # üìù Save ERP records for target pair for debugging
    target_erp = erp_forced[
        erp_forced[ERP_PART_ID].astype(str).str.strip() == "6115990"
    ]
    if not target_erp.empty:
        print(f"üìÑ Found {len(target_erp)} ERP rows for CMPNT_MATL_NUM=6115990")
        target_erp.to_csv("user_logs/target_erp_debug.csv", index=False)
    else:
        print("‚ö†Ô∏è No ERP rows found for CMPNT_MATL_NUM=6115990")

    # Filter TRU records for forced pairs
    tru_forced = tru_full[TRU_MATCH_COLS][
        tru_full[TRU_SPEC_ID].isin(forced_pairs[TRU_SPEC_ID])
    ]
    print(f"‚úÖ TRU records found for forced pairs: {len(tru_forced)}")

    # üìù Save TRU records for target pair for debugging
    target_tru = tru_forced[
        tru_forced[TRU_SPEC_ID].astype(str).str.strip() == "PC-046458"
    ]
    if not target_tru.empty:
        print(f"üìÑ Found {len(target_tru)} TRU rows for CHILD_NM=PC-046458")
        target_tru.to_csv("user_logs/target_tru_debug.csv", index=False)
    else:
        print("‚ö†Ô∏è No TRU rows found for CHILD_NM=PC-046458")

    # Normalize material numbers for join
    erp_forced[ERP_MAT_NUM] = erp_forced[ERP_MAT_NUM].astype(str).str.strip().str.lstrip("0")
    tru_forced[TRU_MAT_NUM] = tru_forced[TRU_MAT_NUM].astype(str).str.strip().str.lstrip("0")

    # Perform the join
    forced_matches = erp_forced.merge(
        tru_forced,
        left_on=[ERP_MAT_NUM, TRU_SPEC_ID],
        right_on=[TRU_MAT_NUM, TRU_SPEC_ID],
        how='inner'
    )
    print(f"‚úÖ Forced matches found after joining ERP and TRU: {len(forced_matches)}")

    # Check if target pair is in forced matches
    target_forced = forced_matches[
        (forced_matches[ERP_PART_ID].astype(str).str.strip() == "6115990") &
        (forced_matches[TRU_SPEC_ID].astype(str).str.strip() == "PC-046458")
    ]
    if not target_forced.empty:
        print(f"üéâ Target pair is present in forced matches!")
        target_forced.to_csv("user_logs/target_forced_match_debug.csv", index=False)
    else:
        print("‚ùå Target pair is still missing in forced matches.")

    # Save all forced matches for debugging
    forced_matches.to_csv("user_logs/forced_matches_debug.csv", index=False)
