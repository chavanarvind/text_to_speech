df_key = df[key_cols].dropna(subset=["CMPNT_MATL_NUM", "SRC_SYS_CD"]).drop_duplicates()

# Generate composite key
df_key["composite_key"] = (
    df_key["SRC_SYS_CD"].astype(str).str.strip() + "_" +
    df_key["CMPNT_MATL_NUM"].astype(str).str.strip()
)

# Insert only new unique keys into SQLite
keys = df_key["composite_key"].dropna().drop_duplicates().tolist()
new_key_rows = insert_keys_batch(keys, lock)

# Filter to only new (not-seen-before) keys
df_key = df_key[df_key["composite_key"].isin(new_key_rows)]
