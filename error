from azureml.pipeline.core import Schedule, ScheduleRecurrence, TimeZone

pipeline.validate()

if ENV == 'prod':
    experiment = Experiment(ws, name="bom_pipeline_pull_merge_preprocess")

    # Submit the pipeline to get a version to schedule
    pipeline_run = experiment.submit(pipeline)
    print(f"Pipeline submitted. Run ID: {pipeline_run.id}")
    print(f"Link to Azure ML portal: {pipeline_run.get_portal_url()}")

    # Define recurrence: Every Tuesday 18:30 UTC = Wednesday 12:00 AM IST
    recurrence = ScheduleRecurrence(
        frequency='Week',
        interval=1,
        week_days=['Tuesday'],
        time_of_day='18:30',
        time_zone=TimeZone.UTC
    )

    schedule_name = "RPM_Catagarization_Prod"

    # Clean up old schedule (if exists)
    existing_schedules = Schedule.list(ws)
    for sched in existing_schedules:
        if sched.name == schedule_name:
            print(f"Disabling and deleting existing schedule: {sched.name}")
            sched.disable()
            sched.delete()

    # Create new schedule using the latest pipeline definition (not the run)
    new_schedule = Schedule.create(
        workspace=ws,
        name=schedule_name,
        pipeline_id=pipeline.id,  # ✅ Use pipeline.id here, not pipeline_run
        experiment_name=experiment.name,
        recurrence=recurrence,
        description="Runs RPM Categorization pipeline every Wednesday 12:00 AM IST",
        wait_for_provisioning=True
    )

    print(f"✅ New schedule created: {new_schedule.name}")

else:
    print("ℹ️ Dev environment detected — pipeline will not be scheduled or submitted.")
