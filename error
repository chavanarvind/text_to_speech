import numpy as np
import joblib
from lightgbm import LGBMClassifier, early_stopping, log_evaluation
from sklearn.model_selection import train_test_split
from sklearn.metrics import classification_report, confusion_matrix, f1_score

# --- LOAD FEATURES AND LABELS ---
X = np.load('./data/validation_step/model_artifects/X_full.npy',allow_pickle=True)
y = np.load('./data/validation_step/model_artifects/y_full.npy',allow_pickle=True)

# --- SPLIT INTO TRAIN/VALIDATION ---
X_train, X_val, y_train, y_val = train_test_split(
    X, y, test_size=0.2, stratify=y, random_state=42
)

# --- TRAIN LIGHTGBM MODEL ---
model = LGBMClassifier(class_weight='balanced', random_state=42)

# Train with early stopping and logging
model.fit(
    X_train,
    y_train,
    eval_set=[(X_val, y_val)],
    eval_metric='logloss',
    callbacks=[
        early_stopping(10),
        log_evaluation(10)
    ]
)

# --- SAVE MODEL ---
joblib.dump(model, './data/validation_step/model_artifects/final_model.joblib')
print("âœ… LightGBM model saved: final_model.joblib")

# --- EVALUATION ---
y_pred = model.predict(X_val)

print("\nðŸ“Š Classification Report:")
report = classification_report(y_val, y_pred)
print(report)

print("ðŸ”¢ Confusion Matrix:")
print(confusion_matrix(y_val, y_pred))

f1 = f1_score(y_val, y_pred, average='weighted')
print(f"\nâœ… Weighted F1 Score: {f1:.4f}")

# --- SAVE REPORT ---
with open('./data/validation_step/model_artifects/classification_report.txt', 'w') as f:
    f.write(report)
    f.write(f"\nF1 Score (weighted): {f1:.4f}\n")

File /anaconda/envs/azureml_py38/lib/python3.10/site-packages/numpy/lib/format.py:793, in read_array(fp, allow_pickle, pickle_kwargs, max_header_size)
    791     pickle_kwargs = {}
    792 try:
--> 793     array = pickle.load(fp, **pickle_kwargs)
    794 except UnicodeError as err:
    795     # Friendlier error message
    796     raise UnicodeError("Unpickling a python object failed: %r\n"
    797                        "You may need to pass the encoding= option "
    798                        "to numpy.load" % (err,)) from err

ModuleNotFoundError: No module named 'numpy._core'
