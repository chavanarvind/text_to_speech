merged_df = key_df.merge(
    final_df[[
        "CMPNT_MATL_NUM",
        "AI_FINAL_CATEGORY",
        "AI_FINAL_SUBCATEGORY",
        "AI_FINAL_CATEGORY_CONFIDENCE",
        "AI_FINAL_SUBCATEGORY_CONFIDENCE",
        "AI_MATCHING_REASON_FINAL_CATEGORY",
        "AI_MATCHING_REASON_FINAL_SUBCATEGORY"
    ]],
    how="left", on="CMPNT_MATL_NUM"
)

# üîç Add this validation block here
if len(merged_df) != len(key_df):
    print(f"‚ùå Row count mismatch: original = {len(key_df)}, merged = {len(merged_df)}")
else:
    print(f"‚úÖ Row count validated: {len(merged_df)} rows")

out_path = os.path.join(mapped_keys_dir, key_file)
merged_df.to_parquet(out_path, index=False)
log(f"‚úÖ Saved mapped key file: {out_path}")
