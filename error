from azureml.core import Workspace, Datastore
import os
from datetime import datetime

# === Azure ML Config ===
SUBSCRIPTION_ID = "a8d518a9-4587-4ba2-9a60-68b980c2f000"
RESOURCE_GROUP = "AZR-WDZ-DTO-AML-Development"
WORKSPACE_NAME = "AML-DTO-Marmot-dev"
DATASTORE_NAME = "xbomrefadlsg2"

# === Paths ===
local_folder = "./data/final_merged_predictions_updated"
blob_output_path = f"hbom_category_prediction/hbom_category_prediction_{datetime.today().strftime('%d%m%Y')}_updated/"

# === Get workspace and datastore ===
ws = Workspace(subscription_id=SUBSCRIPTION_ID,
               resource_group=RESOURCE_GROUP,
               workspace_name=WORKSPACE_NAME)

datastore_wrapper = Datastore.get(ws, DATASTORE_NAME)

# ðŸ’¡ Use the inner ._datastore attribute to access working method
files_to_upload = [
    os.path.join(local_folder, f)
    for f in os.listdir(local_folder)
    if f.endswith(".parquet")
]

datastore_wrapper._datastore.upload_files(
    files=files_to_upload,
    target_path=blob_output_path,
    overwrite=True,
    show_progress=True,
    relative_root=local_folder
)

print(f"âœ… Uploaded {len(files_to_upload)} files to Azure Data Lake Gen2: {blob_output_path}")
