key_df.to_parquet(key_file_path, index=False)
os.makedirs(os.path.dirname(key_file_path), exist_ok=True)  # ✅ Ensure directory exists
key_df.to_parquet(key_file_path, index=False)

def register_final_output_dir(output_dir, ws):
    print(f"[INFO] Registering final mapped output from: {output_dir}")
    parquet_files = glob.glob(os.path.join(output_dir, "*.parquet"))
    if not parquet_files:
        print(f"[WARN] No Parquet files found to register in {output_dir}")
        return
    datastore = ws.get_default_datastore()
    dataset = Dataset.Tabular.from_parquet_files([(datastore, os.path.join(output_dir, "*.parquet"))])
    dataset.register(ws, name="bom_final_mapped_dataset", description="Final mapped output from step1a", create_new_version=True)
    print("✅ Registered: bom_final_mapped_dataset")
