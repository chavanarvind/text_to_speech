import os
import argparse
from azureml.core import Run, Dataset
import glob
import shutil

def main(output_path):
    run = Run.get_context()
    ws = run.experiment.workspace

    # Load dataset directly
    dataset = Dataset.get_by_name(ws, name='harmonized_bom_data_asset')

    # Download full dataset to temp directory
    temp_dir = os.path.join(output_path, "full_download")
    os.makedirs(temp_dir, exist_ok=True)
    dataset.download(target_path=temp_dir, overwrite=True)
    print(f"✅ Dataset downloaded to temp: {temp_dir}")

    # Find parquet files from downloaded folder
    all_parquet_files = glob.glob(os.path.join(temp_dir, "**", "*.parquet"), recursive=True)

    if not all_parquet_files:
        raise FileNotFoundError("❌ No `.parquet` files found in the downloaded dataset.")

    # Pick first 2 parquet files for testing
    os.makedirs(output_path, exist_ok=True)
    for i, f in enumerate(all_parquet_files[:2]):
        shutil.copy(f, os.path.join(output_path, f"test_file_{i+1}.parquet"))

    print(f"✅ Copied {min(2, len(all_parquet_files))} parquet file(s) to: {output_path}")


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--output_path", type=str, required=True)
    args = parser.parse_args()

    main(args.output_path)
