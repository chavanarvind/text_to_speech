from azureml.pipeline.core import Schedule
from azureml.pipeline.core.schedule import Recurrence, ScheduleTrigger

if ENV == 'prod':
    experiment = Experiment(ws, name="bom_pipeline_pull_merge_preprocess")
    pipeline_run = experiment.submit(pipeline)

    # New Recurrence format (UTC time = 18:30 Tuesday = 12:00 AM IST Wednesday)
    recurrence = Recurrence(
        frequency="Week",
        interval=1,
        schedule={
            "week_days": ["Tuesday"],
            "hours": [18],
            "minutes": [30],
            "time_zone": "UTC"
        }
    )

    schedule_name = "RPM_Catagarization_Prod"

    # Clean up old schedule
    for sched in Schedule.list(ws):
        if sched.name == schedule_name:
            print(f"Disabling and deleting existing schedule: {sched.name}")
            sched.disable()
            sched.delete()

    # Create new schedule
    new_schedule = Schedule.create(
        workspace=ws,
        name=schedule_name,
        pipeline_id=pipeline_run.pipeline_id,
        experiment_name=experiment.name,
        trigger=ScheduleTrigger(recurrence=recurrence),
        description="Runs RPM Categorization pipeline every Wednesday 12:00 AM IST",
        wait_for_provisioning=True
    )

    print(f"New schedule created: {new_schedule.name}")

else:
    print("Dev environment detected â€” skipping scheduling.")
