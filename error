from azureml.pipeline.core import Schedule, ScheduleRecurrence

pipeline.validate()

if ENV == 'prod':
    # Submit pipeline to get the latest pipeline ID
    experiment = Experiment(ws, name="bom_pipeline_pull_merge_preprocess")
    pipeline_run = experiment.submit(pipeline)

    # Recurrence: Every Tuesday 6:30 PM UTC (Wednesday 12:00 AM IST)
    recurrence = ScheduleRecurrence(
        frequency="Week",
        interval=1,
        week_days=["Tuesday"],
        time="18:30",  # 12:00 AM IST
        time_zone="UTC"
    )

    schedule_name = "RPM_Catagarization_Prod"

    # Disable and delete existing schedule if it exists
    existing_schedules = Schedule.list(ws)
    for sched in existing_schedules:
        if sched.name == schedule_name:
            print(f"Disabling and deleting existing schedule: {sched.name}")
            sched.disable()
            sched.delete()

    # Create new schedule with latest pipeline ID
    new_schedule = Schedule.create(
        workspace=ws,
        name=schedule_name,
        pipeline_id=pipeline_run.pipeline_id,
        experiment_name=experiment.name,
        recurrence=recurrence,
        description="Runs the RPM Categorization pipeline every Wednesday 12:00 AM IST",
        wait_for_provisioning=True
    )

    print(f"New schedule created: {new_schedule.name}")

else:
    print("Dev environment detected â€” pipeline will not be submitted or scheduled.")
